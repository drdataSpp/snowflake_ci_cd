name: Deploy data pipeline

on:
  pull_request:
    branches:
      - master  # Trigger the workflow when a PR is merged into master

  push:
    branches:
      - Snowflake-Deployment-*  # Trigger on pushes to branches starting with "DST-"

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      REPO_NAME: "SOORYA_TEST.GITHUB.GITHUB_REPO"
      # Read connection secrets
      SNOWFLAKE_CONNECTIONS_DEFAULT_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}

    steps:
      # Checkout step to fetch the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get branch name
        id: branch_name
        run: |
          # Extract the branch name from GITHUB_REF
          branch_name=${GITHUB_REF#refs/heads/}
          echo "Branch name is: $branch_name"
          echo "branch_name=$branch_name" >> $GITHUB_ENV

      - name: Get list of changed files
        id: changed_files
        run: |
          # Fetch all branches for comparison
          git fetch origin

          # Get the base and head branches for the pull request
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          HEAD_BRANCH="${{ github.event.pull_request.head.ref }}"

          echo "Base branch: $BASE_BRANCH"
          echo "Head branch: $HEAD_BRANCH"

          # Compare the base branch with the head branch to find changes
          git diff --name-only origin/$BASE_BRANCH..origin/$HEAD_BRANCH > changed_files.txt

          # Output the list of changed files
          echo "Changed files:"
          cat changed_files.txt

          # Set the list of changed files as an output variable
          changed_files=$(cat changed_files.txt | tr '\n' ' ')
          echo "changed_files=$changed_files" >> $GITHUB_ENV

      - name: Use the changed files
        run: |
          echo "The changed files are: ${{ env.changed_files }}"

      - name: Install Snowflake CLI
        uses: Snowflake-Labs/snowflake-cli-action@v1.5
        with:
          cli-version: "latest"
          default-config-file-path: ".snowflake/config.toml"

      - name: Fetch repository changes in Snowflake
        run: snow git fetch "${REPO_NAME}"

      - name: Execute Snowflake SQL scripts in order
        if: env.changed_files != ''
        run: |
          echo "Processing changed files: ${{ env.changed_files }}"
      
          # Define the execution order for database change management
          declare -a execution_order=("snowflake_resources/database" "snowflake_resources/schema" "snowflake_resources/table")

          # Process files based on the defined execution order
          for level in "${execution_order[@]}"; do
            echo "Processing changes in $level"

            for file in ${{ env.changed_files }}; do
              # Check if the file belongs to the current level and is a SQL file
              if [[ $file == $level* && $file == *.sql ]]; then
                echo "Executing SQL script: $file"
                
                # Construct the Snowflake repository path for the file
                full_repo_path="@SOORYA_TEST.GITHUB.GITHUB_REPO/branches/${{ env.branch_name }}/$file"
                echo "Executing on repo path: $full_repo_path"
                
                # Execute the SQL script
                snow git execute "$full_repo_path"
              else
                echo "Skipping non-SQL file or file not in $level: $file"
              fi
            done
          done
