name: Deploy Snowflake Objects to PROD Environment

on:
  pull_request_review:
    types:
      - submitted
  pull_request:
    paths:
      - 'snowflake_resources/**'

jobs:
  check-approvals:
    runs-on: ubuntu-latest
    outputs:
      approved: ${{ steps.check.outputs.approved }}
    steps:
      - name: Check approvals
        id: check
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            const approvals = reviews.filter(review => review.state === 'APPROVED');
            console.log(`Number of approvals: ${approvals.length}`);
            core.setOutput('approved', approvals.length >= 1);

  check-changes:
    runs-on: ubuntu-latest
    needs: check-approvals
    outputs:
      changes_in_snowflake_resources: ${{ steps.check-changes.outputs.changes_in_snowflake_resources }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get base and head branches of PR
        id: pr_branch_info
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('base_ref', pr.data.base.ref);
            core.setOutput('head_ref', pr.data.head.ref);

      - name: Get list of changed files
        id: check-changes
        run: |
          BASE_REF="${{ steps.pr_branch_info.outputs.base_ref }}"
          HEAD_REF="${{ steps.pr_branch_info.outputs.head_ref }}"
          git fetch origin "$BASE_REF" "$HEAD_REF"
          git diff --name-only origin/$BASE_REF...origin/$HEAD_REF > changed_files.txt

          echo "Changed files:"
          cat changed_files.txt

          if grep -q '^snowflake_resources/' changed_files.txt; then
            echo "Changes found in snowflake_resources folder"
            echo "changes_in_snowflake_resources=true" >> $GITHUB_OUTPUT
          else
            echo "No changes found in snowflake_resources folder"
            echo "changes_in_snowflake_resources=false" >> $GITHUB_OUTPUT

  deploy-to-prod:
    needs: [check-approvals, check-changes]
    if: needs.check-approvals.outputs.approved == 'true' && needs.check-changes.outputs.changes_in_snowflake_resources == 'true'
    runs-on: ubuntu-latest
    permissions: write-all
    env:
      REPO_NAME: "GITHUB.SNOWFLAKE_GIT.SNOWFLAKE_REPO"
      ENV: "PROD"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Snowflake account for PROD
        run: |
          echo "SNOWFLAKE_CONNECTIONS_DEFAULT_ACCOUNT=${{ secrets.SNOWFLAKE_ACCOUNT_PROD }}" >> $GITHUB_ENV
          echo "SNOWFLAKE_CONNECTIONS_DEFAULT_USER=${{ secrets.SNOWFLAKE_USER_PROD }}" >> $GITHUB_ENV
          echo "SNOWFLAKE_CONNECTIONS_DEFAULT_PASSWORD=${{ secrets.SNOWFLAKE_PASSWORD_PROD }}" >> $GITHUB_ENV

      - name: Fetch repository changes in Snowflake
        run: snow git fetch "${REPO_NAME}"

      - name: Execute Snowflake SQL scripts in order
        id: execute_scripts
        run: |
          set +e
          echo "Using environment: ${{ env.ENV }}"
          declare -a execution_order=("snowflake_resources/01_backup_deletes" "snowflake_resources/database" "snowflake_resources/schema" "snowflake_resources/table")
          deployed_files=""
          failed_files=""
          for level in "${execution_order[@]}"; do
            echo "Processing changes in $level"
            for file in $(git diff --name-only origin/${{ steps.pr_branch_info.outputs.base_ref }}...origin/${{ steps.pr_branch_info.outputs.head_ref }} | grep "$level/.*\.sql"); do
              echo "Executing SQL script: $file"
              branch_name="${{ steps.pr_branch_info.outputs.head_ref }}"
              full_repo_path="@$REPO_NAME/branches/$branch_name/$file"
              echo "Executing on repo path: $full_repo_path"
              if snow git execute "$full_repo_path"; then
                deployed_files+="$file "
              else
                failed_files+="$file "
                echo "Failed to execute $file"
              fi
            done
          done
          echo "deployed_files=$deployed_files" >> $GITHUB_OUTPUT
          echo "failed_files=$failed_files" >> $GITHUB_OUTPUT
          if [[ -n "$failed_files" ]]; then
            exit 1
          fi

      - name: Post PROD Deployment Status
        if: always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const deployedFiles = '${{ steps.execute_scripts.outputs.deployed_files }}'.trim().split(' ').filter(Boolean);
            const failedFiles = '${{ steps.execute_scripts.outputs.failed_files }}'.trim().split(' ').filter(Boolean);
            const env = '${{ env.ENV }}';
            const status = '${{ job.status }}';

            let message = `ğŸš€ğŸš€ **Deployment to ${env} environment** ğŸš€ğŸš€\n\n`;

            if (deployedFiles.length > 0) {
              message += `Successfully deployed files:\n`;
              message += deployedFiles.map(file => `- ${file}`).join('\n') + '\n\n';
            }

            if (failedFiles.length > 0) {
              message += `Failed to deploy files:\n`;
              message += failedFiles.map(file => `- ${file}`).join('\n') + '\n\n';
            }

            message += `Deployment status: **${status}** ${status.toLowerCase() === 'success' ? 'âœ…ğŸ˜' : 'âŒğŸ˜'}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
